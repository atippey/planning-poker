name: Deploy to Production

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to deploy (e.g., 1.0.4)'
        required: true
        type: string

permissions:
  contents: read

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    environment: prod-release
    steps:
      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_PAT }}

      - name: Deploy to production
        env:
          SSH_PRIVATE_KEY: ${{ secrets.DEPLOY_SSH_KEY }}
          PROD_USER: ${{ secrets.PROD_USER }}
          PROD_HOST: ${{ secrets.PROD_HOST }}
          KUBE_NAMESPACE: ${{ secrets.KUBE_NAMESPACE }}
          VERSION: ${{ inputs.version }}
          REGISTRY: ghcr.io
          IMAGE_PREFIX: ${{ github.repository_owner }}
        run: |
          # Setup SSH
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H "$PROD_HOST" >> ~/.ssh/known_hosts

          VERSION="${VERSION#v}"

          # Fail fast if the images aren't published.
          docker manifest inspect "$REGISTRY/$IMAGE_PREFIX/planning-poker-api:$VERSION" >/dev/null
          docker manifest inspect "$REGISTRY/$IMAGE_PREFIX/planning-poker-ui:$VERSION" >/dev/null

          # Deploy via SSH - run kubectl commands directly on the Pi
          ssh -i ~/.ssh/id_ed25519 "${PROD_USER}@${PROD_HOST}" << ENDSSH
            set -e

            # Update deployment with new image tags
            kubectl -n "$KUBE_NAMESPACE" set image deployment/planning-poker-api \
              api=$REGISTRY/$IMAGE_PREFIX/planning-poker-api:$VERSION

            kubectl -n "$KUBE_NAMESPACE" set image deployment/planning-poker-ui \
              ui=$REGISTRY/$IMAGE_PREFIX/planning-poker-ui:$VERSION

            # Wait for rollout
            kubectl -n "$KUBE_NAMESPACE" rollout status deployment/planning-poker-api --timeout=5m
            kubectl -n "$KUBE_NAMESPACE" rollout status deployment/planning-poker-ui --timeout=5m

            echo "âœ… Deployed version $VERSION to production"
          ENDSSH
